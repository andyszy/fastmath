<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powers of 2 Master - Fast Math Practice</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .root {
            display: inline-flex;
            align-items: center;
            position: relative;
        }
        .root-symbol {
            font-size: 1em;
            line-height: 1;
        }
        .root-radicand {
            border-top: 6px solid currentColor;
            padding: 0 0.2em;
            margin-left: -0.1em;
        }
        .root-index {
            font-size: 0.6em;
            vertical-align: super;
            margin-right: -0.2em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icon components
        const Trophy = ({ className, size = 24, fill = "none" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                <path d="M4 22h16" />
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
            </svg>
        );

        const Play = ({ className, size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
        );

        const BarChart3 = ({ className, size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 3v18h18" />
                <path d="M18 17V9" />
                <path d="M13 17V5" />
                <path d="M8 17v-3" />
            </svg>
        );

        const PowersOf2Master = () => {
            const [activeTab, setActiveTab] = useState('play');
            const [gameActive, setGameActive] = useState(false);
            const [timeLeft, setTimeLeft] = useState(300); // 5 minutes
            const [currentProblem, setCurrentProblem] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState('');
            const [streak, setStreak] = useState(0);
            const [problemStartTime, setProblemStartTime] = useState(null);
            const answerInputRef = React.useRef(null);

            // Powers of 2 lookup
            const powersOf2 = {
                0: 1, 1: 2, 2: 4, 3: 8, 4: 16, 5: 32, 6: 64, 7: 128, 8: 256, 9: 512,
                10: 1024, 11: 2048, 12: 4096, 13: 8192, 14: 16384, 15: 32768, 16: 65536
            };

            // Load progress from localStorage
            const [progress, setProgress] = useState(() => {
                const saved = localStorage.getItem('powers2Progress');
                if (saved) {
                    return JSON.parse(saved);
                }
                // Initialize progress for 0-16
                const initial = {};
                for (let i = 0; i <= 16; i++) {
                    initial[i] = {
                        correct: 0,
                        total: 0,
                        streak: 0,
                        hasTrophy: false,
                        lastPracticed: null,
                        responseTimes: []
                    };
                }
                return initial;
            });

            // Save progress to localStorage whenever it changes
            useEffect(() => {
                localStorage.setItem('powers2Progress', JSON.stringify(progress));
            }, [progress]);

            // Timer countdown
            useEffect(() => {
                if (gameActive && timeLeft > 0) {
                    const timer = setInterval(() => {
                        setTimeLeft(prev => prev - 1);
                    }, 1000);
                    return () => clearInterval(timer);
                } else if (timeLeft === 0 && gameActive) {
                    endGame();
                }
            }, [gameActive, timeLeft]);

            // Auto-focus answer input when new problem appears or feedback clears
            useEffect(() => {
                if (gameActive && currentProblem && !feedback && answerInputRef.current) {
                    answerInputRef.current.focus();
                }
            }, [gameActive, currentProblem, feedback]);

            // Generate problem using spaced repetition
            const generateProblem = () => {
                // Weight selection based on streak (lower streak = higher probability)
                const weights = [];
                for (let i = 0; i <= 16; i++) {
                    const currentStreak = progress[i].streak || 0;
                    const hasTrophy = progress[i].hasTrophy;
                    // If trophy earned, give low weight; otherwise weight by (10 - streak)
                    const weight = hasTrophy ? 5 : (10 - currentStreak) + 20;
                    weights.push({ power: i, weight });
                }

                const totalWeight = weights.reduce((sum, w) => sum + w.weight, 0);
                let random = Math.random() * totalWeight;
                let selectedPower = 0;

                for (const w of weights) {
                    random -= w.weight;
                    if (random <= 0) {
                        selectedPower = w.power;
                        break;
                    }
                }

                const value = powersOf2[selectedPower];

                // Categories 0 and 1 only have power questions
                // Categories 2+ have both power and root questions
                let isPower;
                if (selectedPower === 0 || selectedPower === 1) {
                    isPower = true;
                } else {
                    isPower = Math.random() < 0.5;
                }

                if (isPower) {
                    return {
                        power: selectedPower,
                        type: 'power',
                        questionPower: selectedPower,
                        answer: value
                    };
                } else {
                    return {
                        power: selectedPower,
                        type: 'root',
                        questionValue: value,
                        questionPower: selectedPower,
                        answer: 2
                    };
                }
            };

            const startGame = () => {
                setGameActive(true);
                setTimeLeft(300);
                setStreak(0);
                setFeedback('');
                setCurrentProblem(generateProblem());
                setProblemStartTime(Date.now());
            };

            const endGame = () => {
                setGameActive(false);
                setCurrentProblem(null);
                setUserAnswer('');
                setFeedback('Great session! Check your progress.');
                setTimeout(() => setFeedback(''), 3000);
            };

            const checkAnswer = () => {
                if (!currentProblem || userAnswer === '') return;

                const isCorrect = parseInt(userAnswer) === currentProblem.answer;
                const category = currentProblem.power;

                // Calculate response time in seconds
                const responseTime = problemStartTime ? (Date.now() - problemStartTime) / 1000 : null;

                // Calculate new streak value for feedback
                let newStreakValue = 0;
                let earnedTrophy = false;
                
                if (isCorrect) {
                    const currentCategoryProgress = progress[category];
                    if (!currentCategoryProgress.hasTrophy) {
                        newStreakValue = (currentCategoryProgress.streak || 0) + 1;
                        earnedTrophy = newStreakValue >= 10;
                    } else {
                        newStreakValue = 10;
                        earnedTrophy = true;
                    }
                }

                // Update progress
                setProgress(prev => {
                    const updated = { ...prev };
                    const categoryProgress = { ...updated[category] };

                    // Initialize responseTimes if it doesn't exist (for backward compatibility)
                    if (!categoryProgress.responseTimes) {
                        categoryProgress.responseTimes = [];
                    }
                    // Initialize streak if it doesn't exist (for backward compatibility)
                    if (categoryProgress.streak === undefined) {
                        categoryProgress.streak = 0;
                    }

                    categoryProgress.total += 1;
                    
                    if (isCorrect) {
                        categoryProgress.correct += 1;
                        
                        // Increment streak only if trophy not yet earned
                        if (!categoryProgress.hasTrophy) {
                            categoryProgress.streak += 1;
                            
                            // Award trophy at streak of 10
                            if (categoryProgress.streak >= 10) {
                                categoryProgress.hasTrophy = true;
                            }
                        }

                        // Store response time for correct answers
                        if (responseTime !== null) {
                            categoryProgress.responseTimes.push(responseTime);
                        }
                    } else {
                        // Reset streak on wrong answer (but don't lose trophy)
                        if (!categoryProgress.hasTrophy) {
                            categoryProgress.streak = 0;
                        }
                    }

                    categoryProgress.lastPracticed = new Date().toISOString();
                    updated[category] = categoryProgress;

                    return updated;
                });

                if (isCorrect) {
                    setStreak(prev => prev + 1);
                    const streakEmoji = earnedTrophy ? 'üèÜ' : 'üî•';
                    const streakText = earnedTrophy ? `${streakEmoji}${newStreakValue} in a row!` : `${streakEmoji}${newStreakValue} in a row`;
                    setFeedback(`‚úì Correct! ${streakText}`);
                } else {
                    setStreak(0);
                    const wrongQuestion = currentProblem.type === 'power' 
                        ? `2^${currentProblem.questionPower}` 
                        : `‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ`[currentProblem.questionPower] + `‚àö${currentProblem.questionValue}`;
                    setFeedback(`‚úó Not quite. ${wrongQuestion} = ${currentProblem.answer}\nü•∂ Reset streak to 0`);
                }

                // Move to next problem after short delay
                setTimeout(() => {
                    if (gameActive) {
                        setCurrentProblem(generateProblem());
                        setUserAnswer('');
                        setFeedback('');
                        setProblemStartTime(Date.now());
                    }
                }, isCorrect ? 800 : 2000);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !feedback) {
                    checkAnswer();
                }
            };

            const calculateTotalRewards = () => {
                let total = 0;
                for (let i = 0; i <= 16; i++) {
                    if (progress[i] && progress[i].hasTrophy) {
                        total += 0.50;
                    }
                }
                return total;
            };

            const getAverageResponseTime = (power) => {
                const categoryProgress = progress[power];
                if (!categoryProgress || !categoryProgress.responseTimes || categoryProgress.responseTimes.length === 0) {
                    return null;
                }
                const sum = categoryProgress.responseTimes.reduce((acc, time) => acc + time, 0);
                const avg = sum / categoryProgress.responseTimes.length;
                return avg;
            };

            const getSuperscript = (n) => {
                const superscripts = '‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ';
                return String(n).split('').map(d => superscripts[parseInt(d)]).join('');
            };

            const resetProgress = () => {
                if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                    const initial = {};
                    for (let i = 0; i <= 16; i++) {
                        initial[i] = {
                            correct: 0,
                            total: 0,
                            streak: 0,
                            hasTrophy: false,
                            lastPracticed: null,
                            responseTimes: []
                        };
                    }
                    setProgress(initial);
                    localStorage.setItem('powers2Progress', JSON.stringify(initial));
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-cyan-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-4">
                            <div className="flex items-center justify-between flex-wrap gap-4">
                                <div className="flex items-center gap-3">
                                    <span className="text-4xl">2‚Åø</span>
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-800">Powers of 2</h1>
                                        <p className="text-sm text-gray-600">2‚Å∞ through 2¬π‚Å∂</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <a 
                                        href="/"
                                        className="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors"
                                    >
                                        ‚Üê Back to Menu
                                    </a>
                                </div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="bg-white rounded-lg shadow-lg mb-4">
                            <div className="flex border-b">
                                <button
                                    onClick={() => setActiveTab('play')}
                                    className={`flex-1 flex items-center justify-center gap-2 py-4 font-semibold transition-colors ${
                                        activeTab === 'play'
                                            ? 'text-cyan-600 border-b-2 border-cyan-600'
                                            : 'text-gray-500 hover:text-gray-700'
                                    }`}
                                >
                                    <Play size={20} />
                                    Practice
                                </button>
                                <button
                                    onClick={() => setActiveTab('progress')}
                                    className={`flex-1 flex items-center justify-center gap-2 py-4 font-semibold transition-colors ${
                                        activeTab === 'progress'
                                            ? 'text-cyan-600 border-b-2 border-cyan-600'
                                            : 'text-gray-500 hover:text-gray-700'
                                    }`}
                                >
                                    <BarChart3 size={20} />
                                    Progress
                                    <span className="ml-2 bg-green-100 text-green-700 px-2 py-1 rounded-full text-sm font-bold">
                                        ${calculateTotalRewards().toFixed(2)}
                                    </span>
                                </button>
                            </div>

                            {/* Play Tab */}
                            {activeTab === 'play' && (
                                <div className="p-8">
                                    {!gameActive ? (
                                        <div className="text-center">
                                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Ready to practice?</h2>
                                            <p className="text-gray-600 mb-2">
                                                You'll practice both powers and roots of 2.
                                            </p>
                                            <p className="text-gray-600 mb-6">
                                                Master all 17 categories to earn $8.50 in rewards!
                                            </p>
                                            <button
                                                onClick={startGame}
                                                className="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors inline-flex items-center gap-2"
                                            >
                                                <Play size={24} />
                                                Start Practice
                                            </button>
                                            {feedback && (
                                                <div className="mt-4 text-green-600 font-semibold">
                                                    {feedback}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="space-y-6">
                                            {/* Problem */}
                                            {currentProblem && (
                                                <div className="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-8 text-center">
                                                    <div className="text-5xl font-bold text-gray-800 mb-6">
                                                        {currentProblem.type === 'power' ? (
                                                            <>2{getSuperscript(currentProblem.questionPower)} = ?</>
                                                        ) : (
                                                            <>
                                                                <span className="root">
                                                                    <span className="root-index">{getSuperscript(currentProblem.questionPower)}</span>
                                                                    <span className="root-symbol">‚àö</span>
                                                                    <span className="root-radicand">{currentProblem.questionValue}</span>
                                                                </span>
                                                                {' = ?'}
                                                            </>
                                                        )}
                                                    </div>

                                                    <input
                                                        ref={answerInputRef}
                                                        type="number"
                                                        value={userAnswer}
                                                        onChange={(e) => setUserAnswer(e.target.value)}
                                                        onKeyPress={handleKeyPress}
                                                        className="text-3xl font-bold text-center border-4 border-cyan-300 rounded-lg p-4 w-48 mx-auto block focus:outline-none focus:border-cyan-500"
                                                        placeholder="?"
                                                        autoFocus
                                                        disabled={feedback !== ''}
                                                    />

                                                    <button
                                                        onClick={checkAnswer}
                                                        disabled={userAnswer === '' || feedback !== ''}
                                                        className="mt-6 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-400 text-white font-bold py-3 px-8 rounded-lg text-xl transition-colors"
                                                    >
                                                        Check Answer
                                                    </button>

                                                    {feedback && (
                                                        <div className={`mt-6 text-xl font-bold ${
                                                            feedback.startsWith('‚úì') ? 'text-green-600' : 'text-orange-600'
                                                        }`}>
                                                            {feedback}
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            <button
                                                onClick={endGame}
                                                className="text-gray-600 hover:text-gray-800 underline block mx-auto"
                                            >
                                                End session early
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Progress Tab */}
                            {activeTab === 'progress' && (
                                <div className="p-8">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Your Mastery</h2>
                                    
                                    {/* Total Rewards */}
                                    <div className="bg-gradient-to-r from-green-100 to-yellow-100 border-2 border-yellow-400 rounded-xl p-6 mb-6">
                                        <div className="text-center">
                                            <div className="text-sm font-semibold text-gray-600 mb-1">Total Rewards Earned</div>
                                            <div className="text-4xl font-bold text-green-700">
                                                ${calculateTotalRewards().toFixed(2)}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-2">
                                                $0.50 per mastered category ‚Ä¢ 17 categories total
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16].map(power => {
                                            const categoryProgress = progress[power];
                                            const currentStreak = categoryProgress.streak || 0;
                                            const hasTrophy = categoryProgress.hasTrophy;
                                            const avgTime = getAverageResponseTime(power);

                                            return (
                                                <div
                                                    key={power}
                                                    className={`relative border-2 rounded-xl p-4 transition-all ${
                                                        hasTrophy
                                                            ? 'border-yellow-400 bg-gradient-to-br from-yellow-50 to-yellow-100'
                                                            : 'border-cyan-200 bg-cyan-50 hover:border-cyan-300'
                                                    }`}
                                                >
                                                    {hasTrophy && (
                                                        <div className="absolute -top-3 -right-3">
                                                            <Trophy className="text-yellow-500" size={32} fill="currentColor" />
                                                        </div>
                                                    )}

                                                    <div className="text-center">
                                                        <div className="text-2xl font-bold text-gray-800 mb-3">
                                                            2{getSuperscript(power)}
                                                        </div>

                                                        {!hasTrophy ? (
                                                            <div className="text-2xl font-bold text-gray-700 my-2">
                                                                üî• {currentStreak}/10
                                                            </div>
                                                        ) : (
                                                            <div className="text-xl font-bold text-yellow-600 my-2">
                                                                üèÜ Mastered!
                                                            </div>
                                                        )}

                                                        {categoryProgress.total > 0 && (
                                                            <div className="text-xs text-gray-600 mt-1">
                                                                ‚úì {categoryProgress.correct}/{categoryProgress.total}
                                                                {avgTime !== null && `, ‚è± ${avgTime.toFixed(1)}s`}
                                                            </div>
                                                        )}

                                                        <div className={`mt-2 text-sm font-bold ${
                                                            hasTrophy ? 'text-green-700' : 'text-gray-500'
                                                        }`}>
                                                            {hasTrophy ? '‚úì ' : ''}$0.50 {hasTrophy ? 'earned!' : 'reward'}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="mt-8 text-center text-sm text-gray-500">
                                        <p>Get üî•10 correct in a row to earn $0.50 and a permanent trophy! üèÜ</p>
                                        <p className="mt-2">Categories 0 & 1: power only ‚Ä¢ Categories 2-16: power & root</p>
                                        <p className="mt-2 text-xs">Wrong answer resets streak to 0, but trophies are permanent!</p>
                                    </div>

                                    <div className="mt-6 text-center">
                                        <button
                                            onClick={resetProgress}
                                            className="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors"
                                        >
                                            Reset All Progress
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="mt-4 text-center text-sm text-gray-500">
                            <a 
                                href="https://github.com/andyszy/fastmath" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="hover:text-cyan-600 transition-colors"
                            >
                                View on GitHub
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<PowersOf2Master />, document.getElementById('root'));
    </script>
</body>
</html>

